// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Production: PostgreSQL on Railway
  url      = env("DATABASE_URL")
}

// --------------------------------------
// 1. Promotions & Configuration
// --------------------------------------

model Promotion {
  id                  Int       @id @default(autoincrement())
  name                String
  description         String?
  start_datetime      DateTime
  end_datetime        DateTime
  status              String    @default("draft") // draft, active, closed
  planned_token_count Int       @default(0)
  
  // Leaderboard config
  leaderboard_active  Boolean   @default(true)
  leaderboard_size    Int       @default(10)
  
  // Legal
  terms_url           String?
  privacy_url         String?

  // Relations
  prizes              PrizeType[]
  tokens              Token[]
  customers           Customer[]
  plays               Play[]
  prize_assignments   PrizeAssignment[]
  final_leaderboard   FinalLeaderboard[] 

  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt
}

// --------------------------------------
// 2. Prize Model
// --------------------------------------

model PrizeType {
  id                      Int      @id @default(autoincrement())
  promotion_id            Int
  promotion               Promotion @relation(fields: [promotion_id], references: [id])
  
  name                    String
  description             String?
  initial_stock           Int
  remaining_stock         Int
  target_overall_probability Float? // e.g. 0.02 for 2%
  
  assignments             PrizeAssignment[]
}

model PrizeAssignment {
  id                  Int       @id @default(autoincrement())
  promotion_id        Int
  promotion           Promotion @relation(fields: [promotion_id], references: [id])
  
  prize_type_id       Int
  prize_type          PrizeType @relation(fields: [prize_type_id], references: [id])
  
  customer_id         Int
  customer            Customer  @relation(fields: [customer_id], references: [id])
  
  token_id            Int       @unique
  token               Token     @relation(fields: [token_id], references: [id])
  
  play_id             Int       @unique
  play                Play      @relation(fields: [play_id], references: [id])

  prize_code          String    @unique // Code to show to staff
  
  assigned_at         DateTime  @default(now())
  redeemed_at         DateTime?
  redeemed_by_staff_id Int?
  redeemed_by_staff   StaffUser? @relation(fields: [redeemed_by_staff_id], references: [id])
}

// --------------------------------------
// 3. Tokens
// --------------------------------------

model Token {
  id              Int       @id @default(autoincrement())
  promotion_id    Int
  promotion       Promotion @relation(fields: [promotion_id], references: [id])
  
  token_code      String    @unique
  status          String    @default("available") // available, used, invalid
  batch_id        String?   // Optional batch reference
  
  created_at      DateTime  @default(now())
  used_at         DateTime?
  
  play            Play?
  prize_assignment PrizeAssignment?
}

// --------------------------------------
// 4. Customers & Plays
// --------------------------------------

model Customer {
  id                  Int       @id @default(autoincrement())
  promotion_id        Int
  promotion           Promotion @relation(fields: [promotion_id], references: [id])
  
  first_name          String
  last_name           String
  phone_number        String
  
  total_plays         Int       @default(0)
  
  // Consents
  consent_marketing   Boolean   @default(false)
  consent_terms       Boolean   @default(false)
  marketing_consent_at DateTime? 
  terms_consent_at     DateTime? 

  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  plays               Play[]
  prize_assignments   PrizeAssignment[]
  final_rank          FinalLeaderboard[] 

  @@unique([promotion_id, phone_number]) // Unico utente per promozione
}

model Play {
  id                  Int       @id @default(autoincrement())
  promotion_id        Int
  promotion           Promotion @relation(fields: [promotion_id], references: [id])
  
  token_id            Int       @unique
  token               Token     @relation(fields: [token_id], references: [id])
  
  customer_id         Int
  customer            Customer  @relation(fields: [customer_id], references: [id])
  
  is_winner           Boolean   @default(false)
  prize_assignment    PrizeAssignment?
  
  created_at          DateTime  @default(now())
}

// --------------------------------------
// 5. Staff & Admin
// --------------------------------------

model StaffUser {
  id              Int       @id @default(autoincrement())
  username        String    @unique
  password_hash   String
  role            String    @default("staff") // staff, admin
  created_at      DateTime  @default(now())
  
  redeemed_prizes PrizeAssignment[]
}

// --------------------------------------
// 6. Final Leaderboard (Snapshot)
// --------------------------------------

model FinalLeaderboard {
  id           Int      @id @default(autoincrement())
  promotion_id Int
  promotion    Promotion @relation(fields: [promotion_id], references: [id])
  customer_id  Int
  customer     Customer @relation(fields: [customer_id], references: [id])
  
  rank         Int
  total_plays  Int
  snapshot_at  DateTime @default(now())
  
  // Campi denormalizzati per export facile
  first_name   String?
  last_name    String?
  phone_number String?
}